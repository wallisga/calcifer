{% extends "base.html" %}
{% block title %}{{ service.name }} - Service Detail - Calcifer{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="/services">Services</a></li>
                    <li class="breadcrumb-item active">{{ service.name }}</li>
                </ol>
            </nav>
            <h2>
                <i class="bi bi-hdd-stack"></i> {{ service.name }}
                <span class="badge bg-secondary ms-2">{{ service.service_type }}</span>
                {% if service.status == 'active' %}
                <span class="badge bg-success ms-1">Active</span>
                {% elif service.status == 'inactive' %}
                <span class="badge bg-secondary ms-1">Inactive</span>
                {% else %}
                <span class="badge bg-warning ms-1">Maintenance</span>
                {% endif %}
            </h2>
        </div>
        <div>
            <a href="/services" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Services
            </a>
        </div>
    </div>

    <!-- Success/Error Messages -->
    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="serviceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details"
                type="button" role="tab">
                <i class="bi bi-info-circle"></i> Details
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="hosts-tab" data-bs-toggle="tab" data-bs-target="#hosts" type="button"
                role="tab">
                <i class="bi bi-hdd-network"></i> Hosts
                <span class="badge bg-secondary">{{ hosts|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="configs-tab" data-bs-toggle="tab" data-bs-target="#configs" type="button"
                role="tab">
                <i class="bi bi-file-earmark-text"></i> Config Files
                <span class="badge bg-secondary">{{ config_files|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="endpoints-tab" data-bs-toggle="tab" data-bs-target="#endpoints" type="button"
                role="tab">
                <i class="bi bi-broadcast"></i> Endpoints
                <span class="badge bg-secondary">{{ endpoints|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="work-items-tab" data-bs-toggle="tab" data-bs-target="#work-items" type="button"
                role="tab">
                <i class="bi bi-kanban"></i> Work Items
                <span class="badge bg-secondary">{{ work_items|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="documentation-tab" data-bs-toggle="tab" data-bs-target="#documentation"
                type="button" role="tab">
                <i class="bi bi-file-earmark-richtext"></i> Documentation
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="git-tab" data-bs-toggle="tab" data-bs-target="#git" type="button" role="tab">
                <i class="bi bi-git"></i> Git
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="serviceTabsContent">

        <!-- Details Tab -->
        <div class="tab-pane fade show active" id="details" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Service Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="200">Name:</th>
                                    <td>{{ service.name }}</td>
                                </tr>
                                <tr>
                                    <th>Type:</th>
                                    <td><span class="badge bg-secondary">{{ service.service_type }}</span></td>
                                </tr>
                                <tr>
                                    <th>Primary Host:</th>
                                    <td>{{ service.host }}</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        {% if service.status == 'active' %}
                                        <span class="badge bg-success">Active</span>
                                        {% elif service.status == 'inactive' %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% else %}
                                        <span class="badge bg-warning">Maintenance</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if service.url %}
                                <tr>
                                    <th>URL:</th>
                                    <td><a href="{{ service.url }}" target="_blank">{{ service.url }}</a></td>
                                </tr>
                                {% endif %}
                                {% if service.description %}
                                <tr>
                                    <th>Description:</th>
                                    <td>{{ service.description }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    {% if service.ports or service.cpu or service.memory %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Resources</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                {% if service.ports %}
                                <tr>
                                    <th width="200">Ports:</th>
                                    <td><code>{{ service.ports }}</code></td>
                                </tr>
                                {% endif %}
                                {% if service.cpu %}
                                <tr>
                                    <th>CPU:</th>
                                    <td>{{ service.cpu }}</td>
                                </tr>
                                {% endif %}
                                {% if service.memory %}
                                <tr>
                                    <th>Memory:</th>
                                    <td>{{ service.memory }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    {% if service.deployment_type or service.docker_compose_path %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Deployment</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                {% if service.deployment_type %}
                                <tr>
                                    <th width="200">Type:</th>
                                    <td><span class="badge bg-info">{{ service.deployment_type }}</span></td>
                                </tr>
                                {% endif %}
                                {% if service.docker_compose_path %}
                                <tr>
                                    <th>Docker Compose:</th>
                                    <td><code>{{ service.docker_compose_path }}</code></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                    data-bs-target="#addHostModal">
                                    <i class="bi bi-plus-circle"></i> Add Host
                                </button>
                                <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                    data-bs-target="#addConfigModal">
                                    <i class="bi bi-plus-circle"></i> Add Config File
                                </button>
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="bi bi-plus-circle"></i> Add Endpoint
                                    <small>(Work Item 3)</small>
                                </button>
                                <button class="btn btn-outline-secondary" disabled>
                                    <i class="bi bi-pencil"></i> Edit Service
                                    <small>(Future)</small>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Timestamps</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-1 small text-muted">
                                <strong>Created:</strong><br>
                                {{ service.created_date.strftime('%Y-%m-%d %H:%M:%S') }}
                            </p>
                            <p class="mb-0 small text-muted">
                                <strong>Last Updated:</strong><br>
                                {{ service.updated_date.strftime('%Y-%m-%d %H:%M:%S') }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hosts Tab -->
        <div class="tab-pane fade" id="hosts" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Service Hosts</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHostModal">
                    <i class="bi bi-plus-circle"></i> Add Host
                </button>
            </div>

            {% if hosts %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Hostname</th>
                            <th>IP Address</th>
                            <th>Role</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for host in hosts %}
                        <tr>
                            <td><strong>{{ host.hostname }}</strong></td>
                            <td>
                                {% if host.ip_address %}
                                <code>{{ host.ip_address }}</code>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if host.role %}
                                <span class="badge bg-info">{{ host.role }}</span>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td class="small">{{ host.description or '' }}</td>
                            <td>
                                <form method="post" action="/services/{{ service.id }}/delete-host/{{ host.id }}"
                                    style="display: inline;" onsubmit="return confirm('Delete this host?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-hdd-network" style="font-size: 3rem;"></i>
                    <p class="mt-3">No hosts configured for this service.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHostModal">
                        Add First Host
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Config Files Tab -->
        <div class="tab-pane fade" id="configs" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Configuration Files</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                    <i class="bi bi-plus-circle"></i> Add Config File
                </button>
            </div>

            {% if config_files %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>File Path</th>
                            <th>Description</th>
                            <th>Tracking</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cf in config_files %}
                        <tr>
                            <td>
                                {% if cf.secrets_file %}
                                <i class="bi bi-lock-fill text-danger" title="Contains secrets"></i>
                                {% elif cf.is_template %}
                                <i class="bi bi-file-earmark-code text-info" title="Template file"></i>
                                {% else %}
                                <i class="bi bi-file-earmark-text"></i>
                                {% endif %}
                                <code>{{ cf.filepath }}</code>
                            </td>
                            <td class="small">{{ cf.description or '' }}</td>
                            <td>
                                {% if cf.git_tracked %}
                                <span class="badge bg-success">Git Tracked</span>
                                {% else %}
                                <span class="badge bg-secondary">Local Only</span>
                                {% endif %}
                                {% if cf.secrets_file %}
                                <span class="badge bg-danger">Secrets</span>
                                {% endif %}
                                {% if cf.is_template %}
                                <span class="badge bg-info">Template</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="/services/{{ service.id }}/delete-config/{{ cf.id }}"
                                    style="display: inline;"
                                    onsubmit="return confirm('Remove this config file from tracking?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
                    <p class="mt-3">No configuration files tracked for this service.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                        Add First Config File
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Endpoints Tab -->
        <div class="tab-pane fade" id="endpoints" role="tabpanel">
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-broadcast" style="font-size: 3rem;"></i>
                    <p class="mt-3">Endpoint-to-service linking will be available in Work Item 3.</p>
                    <p class="small">You'll be able to monitor this service with health check endpoints.</p>
                </div>
            </div>
        </div>

        <!-- Work Items Tab -->
        <div class="tab-pane fade" id="work-items" role="tabpanel">
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-kanban" style="font-size: 3rem;"></i>
                    <p class="mt-3">Service-linked work items will be available in Work Item 3.</p>
                    <p class="small">All work items related to this service will be displayed here.</p>
                </div>
            </div>
        </div>

        <!-- Documentation Tab -->
        <div class="tab-pane fade" id="documentation" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Service Documentation</h5>
                </div>
                <div class="card-body">
                    {% if service.readme_path %}
                    <p><strong>README:</strong> <code>{{ service.readme_path }}</code></p>
                    {% endif %}

                    {% if service.architecture_doc %}
                    <h6>Architecture Notes:</h6>
                    <div class="border-start border-3 border-primary ps-3">
                        <p class="text-muted">{{ service.architecture_doc }}</p>
                    </div>
                    {% endif %}

                    {% if not service.readme_path and not service.architecture_doc %}
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-file-earmark-richtext" style="font-size: 2rem;"></i><br>
                        No documentation configured yet.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Git Tab -->
        <div class="tab-pane fade" id="git" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Git Repository</h5>
                </div>
                <div class="card-body">
                    {% if service.git_repo_path %}
                    <table class="table table-borderless">
                        <tr>
                            <th width="200">Local Path:</th>
                            <td><code>{{ service.git_repo_path }}</code></td>
                        </tr>
                        {% if service.git_repo_url %}
                        <tr>
                            <th>Remote URL:</th>
                            <td><code>{{ service.git_repo_url }}</code></td>
                        </tr>
                        {% endif %}
                        {% if service.git_provider %}
                        <tr>
                            <th>Provider:</th>
                            <td><span class="badge bg-primary">{{ service.git_provider }}</span></td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Visibility:</th>
                            <td>
                                {% if service.git_repo_private %}
                                <span class="badge bg-warning">Private</span>
                                {% else %}
                                <span class="badge bg-success">Public</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                    {% else %}
                    <p class="text-muted text-center py-4">
                        <i class="bi bi-git" style="font-size: 2rem;"></i><br>
                        No Git repository configured for this service.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Host Modal -->
<div class="modal fade" id="addHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/services/{{ service.id }}/add-host">
                <div class="modal-header">
                    <h5 class="modal-title">Add Host</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Hostname *</label>
                        <input type="text" class="form-control" name="hostname" required
                            placeholder="e.g., linode-vpn-relay">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP Address</label>
                        <input type="text" class="form-control" name="ip_address" placeholder="e.g., 10.0.0.1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-control" name="role" placeholder="e.g., vpn-server, api-server">
                        <small class="form-text text-muted">Purpose of this host in the service</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"
                            placeholder="Optional description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Host</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Config File Modal -->
<div class="modal fade" id="addConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/services/{{ service.id }}/add-config-file">
                <div class="modal-header">
                    <h5 class="modal-title">Add Configuration File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">File Path *</label>
                        <input type="text" class="form-control" name="filepath" required
                            placeholder="e.g., /etc/nginx/sites-available/app">
                        <small class="form-text text-muted">Full path to the configuration file</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description"
                            placeholder="e.g., Nginx configuration">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="git_tracked" id="gitTracked" checked>
                        <label class="form-check-label" for="gitTracked">
                            Git Tracked
                        </label>
                        <small class="form-text text-muted d-block">
                            Uncheck if file is not version controlled (local only)
                        </small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="secrets_file" id="secretsFile">
                        <label class="form-check-label" for="secretsFile">
                            Contains Secrets
                        </label>
                        <small class="form-text text-muted d-block">
                            Check if file contains passwords, keys, or sensitive data
                        </small>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="is_template" id="isTemplate">
                        <label class="form-check-label" for="isTemplate">
                            Template File
                        </label>
                        <small class="form-text text-muted d-block">
                            Check if this is a template (e.g., .env.template)
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Config File</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}